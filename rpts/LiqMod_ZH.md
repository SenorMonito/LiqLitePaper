---
CJKmainfont: "Noto Sans CJK TC"
title: "基于 Cosmos 的自动做市商（AMM）提案"
subtitle: "小论文"
author: [Dongsam Byun, Hyungyeon Lee]
date: "2021 年 2 月"
subject: "流动性功能模块"
keywords: [Cosmos, Liquidity, DeFi]
book: true
titlepage: true
page-background: "./backgrounds/BackgroundDraft.pdf"
classoption: [oneside]
header-left: "流动性功能模块"
footer-left: "Dongsam Byun, Hyungyeon Lee"
---

# 版本历史

+--------------+------------------+-------------------+-----------------------------+
| 版本         | 日期             | 作者              | 说明                         |
+:=============+:=================+:==================+:============================+
| 0.1          | 2021 年 2 月 3 日 | Dongsam Byun      |                             |
|              |                  | Hyungyeon Lee     | 同行审阅                     |
+--------------+------------------+-------------------+-----------------------------+

# 引言

近来区块链技术的发展使开发者能够在去信任的基础上构建可扩展性的自动化程序。其中一种类型经历了显著的发展，就是自动做市商(AMM) [@UniSwap:AMM-v2]。通过 AMM 缺乏金融知识或无法投入大量资本的投资者也有机会参与做市行为了。

Cosmos 网络[@Cosmos:Intro]所成就的重要进步之一为“跨链技术”(IBC)[@Cosmos:IBC]协议。通过 IBC 技术，很容易把代币转移到 Cosmos 主链上的其他区块链。再加上，IBC Peg 能实现用户在一个区块链存入代币，却在别的区块链提取此款代币。例如，通过 ETH Peggy[@Althea:ETHPeggy]和 BTC Peg，用户可以把以太坊和比特币的资产引入到 Cosmos 网络。

鉴于这些进展，此论文会提出一种在 Cosmos 生态系统上构建的去中心化代币交易所(DEX)的设计方案。此功能模块的特征是整合 AMM 模式、订单簿模式以及多区块批量执行和限价订单的方式来为 Cosmos Hub 提供高流动性。由于 IBC 和 Peg-Zones 推动 Cosmos 生态系统内的代币交易的增长，以去中心化交易所为中心的市场将会成为核心应用。

# Uniswap AMM 模式

最近以太坊生态系统的去中心化金融(DeFi)应用正飞速发展，而其中最值得注意的是 Uniswap 自动做市商(AMM)模式 [@UniSwap:AMM-v2]。

自动做市商是一种去中心化交易所(DEX)机制，使用预先定义的算法给用户兑换代币. AMM 带来许多好处:

- 参与做市行为的大众化: 没有大量资本或金融技术的人也只需存入代币到 AMM 的流动性池就能参与
- 除去中间人: AMM 构建在去中心化区块链网络上，因而用户进行交易时不需要任何中心化机构或抵押
- 简化代币兑换: 用户能够简单进行兑换交易，无需使用复杂的订单管理界面

总的来说，虽然它的结构很简单，AMM 却带来了重大利益，在不同条件的市场中也发挥稳定的作用 [@angeris:2020UniSwapAnalysis]。即使如此它也存在一些缺陷，尤其是在价格不一致和订单执行方面。

## 价格不一致 {#sec:PriceInconsistency}

AMM 模式的核心就是“恒定乘积模式”： $R_{x}R_{y} = k$ ，$R_{x}$ 和 $R_{y}$ 表示不同种类的代币 (x 和 y) 的储备数量，k 是大于零的常数。 代币兑换之前(t)和之后(t+1)， $R_{x}$ 乘 $R_{y}$ 保持不变。所以，

$$ R_{x}(t)R_{y}(t) = R_{x}(t+1)R_{y}(t+1) $$

用户提交订单兑换 $\Delta_{x}$ 的代币时，按照上述公式：

$$ R_{x}R_{y} = (R_{x} + \Delta_{x})\left(R_{y} - \frac{\Delta_{x}}{p_{s}}\right) $$

其中 $p_{s}$ 就是兑换价格。重新排列此方程式的结果如下：

$$ p_{s} = \frac{R_{x} + \Delta_{x}}{R_{y}} $$

不过，新的池价格 $p_{p}$ 如下：

$$ p_{p} = \frac{R_{x} + \Delta_{x}}{R_{y} - \frac{\Delta_{x}}{p_{s}}} = \frac{R_{x} + 2 \Delta_{x}}{R_{y}} = p_{s} + \frac{\Delta_{x}}{R_{y}} $$

如以上方程式所示，兑换后的池价格和兑换价格之间会产生差额：此差额相当于 x 代币的兑换数量和 y 代币的储备数量的比例。这种兑换前后价格不一致引起下面的一些副作用：

- 反复出现价格波动导致过多创造套利机会，多于 AMM 为了发现实时价格所需。
- AMM 机制中存在过多的套利机会，可能会给投资者和交易者带来更多损失。

![恒定乘积模式下发现的价格低效率](./imgs/LiqMod/InefficientPriceDiscoveryFigure.png)

## 订单执行排序

以太坊系统中，一个区块内的交易排序完全取决于矿工的选择，而在 Uniswap 的 AMM 模式当中，交易排序对执行价格的影响极大。此问题不仅在工作量证明算法机制(PoW)上存在，在权益证明机制(PoS)和委托权益证明机制(DPos)的网络环境中也是存在的 [@zhou:2020highfrequency]。如果这种交易排序上的不利因素与上述的价格不一致相结合，在价格方面可能对交易者会产生不利的影响。

验证者有权操控交易排序的另一个问题是 Gas 和延迟竞争。由于交易者之间存在优先执行交易的竞争，Gas 价格不得不会上涨。这还能引起不良行为，比如验证者/矿工和交易者之间的勾结或抢先交易。

## 订单类型

现在的 Uniswap AMM 模式中，订单只在当前的区块中有效，因为即时被确定成交与否，没有成交就会失效。意思就是每个区块完成后就流动性会消失，需要通过新的订单才能恢复流动性。

再加上，AMM 通常不允许限价订单(虽能通过第三方实现)。限价订单是指买卖代币时交易者以指定价格或更有利的价格提交的订单。这跟市价订单不同，限价订单只以预先定好的价格执行，这些订单继续留在订单簿，直到被执行或被取消。这种订单有助于价格发现和促进交易者的市场参与。限价订单还能推动活跃的市场参与者运用各种交易策略，增强流动性并减少兑换价格的滑点，降低用户的交易费用。

## 部分订单的执行

如果订单金额比较大，交易者一般会把订单分成一连串的金额较小的交易，而这些交易要在一段期间内在不同的市场和不同的对象以不同的价格成交。这样做交易者可以为客户提供价格方面的优势，也有利于进行流动性管理。可是这种部分订单的执行是在当前的自动做市商模式中不能实现的。

# Cosmos AMM 提案

基于以上分析，我们提出混合交易模式，就是批量订单簿 [@Wikipedia:OrderBook] 配对算法和 AMM 方法论的结合。

![](./imgs/LiqMod/OrderBookModel.png){ width=200px }\ ![](./imgs/LiqMod/LiquidityPoolModel.png){ width=200px }\ ![](./imgs/LiqMod/HybridModel.png){ width=200px }

- 订单积累在订单簿
- 到了批量执行的高度时，使用配对引擎处理订单簿的订单
- 流动性池使用“相等兑换价格模式”参与配对过程 (参考\ref{sec:EquivPriceModel}节)

而且，这个模式还拥有以下特点：

- 允许还在订单簿的限价订单继续存留，直到它们成交或被取消。处理多数批量订单的过程当中，未成交的订单能继续存在。
- 订单价格跟兑换价格相同时，允许执行部分订单。

## 批量执行

为了解决执行订单有关问题，我们建议运用 **批量执行** 方法论。此概念参考了 [@Pourpouneh:AMM] 概述的 _"批量拍卖"_。

> _另一种解决方案是具有离散清算而非连续清算方式的 DEX，即所谓的“批量拍卖”。通过频繁的批量拍卖，消除订单处理速度所带来的随机性，能够给买卖双方提供同等的交易机会。买卖双方不会为了以指定的价格交易而争取排第一位，因为他们都有同等的机会能够把大量的标购标售提交到在指定的时间窗口里进行同一个双重拍卖。提出批量拍卖的目的本是为了解决高频交易(HFT)在传统金融交易所引起的抢先交易问题 (Budish et al. 2014)。在加密货币的交易中，批量拍卖可以解决许多问题。既然批量拍卖中所有标购标售都被平等对待，就能直接解决抢先交易的问题。由于每个批量根据情况可以容纳尽可能多的订单，可通过时间窗口解决性能限制。_

批量执行的过程中订单会在预先定义的周期内积累在流动性池里，而这些订单可能组成一个或多个区块。之后这些订单被添加到资金池，并在批量的最后阶段被执行。

我们提出的模式有两个主要特点。

- 批量中未执行的订单会留在订单簿中，处理接下来的批量时可能被执行。
- 根据市场情况可以调整处理批量的周期。例如，如果新的订单引起价格严重波动，就可以延长处理批量的周期。延长批量周期能够召集更多交易者参与价格发现，从而交易过程会变得更加均衡稳定。 这类似于许多线上拍卖平台中使用的“延长出价”或“出价延时机制”模式 [@Wikipedia:AuctionTech]。

正如 [@Pourpouneh:AMM] 谈到，为了达成 DEX 的目的，批量执行能够防止抢先交易以及矿工/验证者与交易者之间的勾结，为所有人提供更公平的交易环境。

## 订单配对规则

上述模式在以下条件下进行订单的部分或全部配对并执行：

- 将 X 兑换成 Y 的订单
  - 订单价格 > 兑换价格：此订单的全部数量都进行配对
  - 订单价格 = 兑换价格：此订单进行全部或部分配对
  - 订单价格 < 兑换价格：此订单不进行任何配对
- 将 Y 兑换成 X 的订单
  - 订单价格 < 兑换价格：此订单的全部数量都进行配对
  - 订单价格 = 兑换价格：此订单进行全部或部分配对
  - 订单价格 > 兑换价格：此订单不进行任何配对

流动性池基于相等兑换价格模式为配对订单提供流动性。

## 相等兑换价格模式 {#sec:EquivPriceModel}

正如\ref{sec:PriceInconsistency}节的分析，恒定乘积模式导致执行交易前后的兑换价格和池价格之间的差异。正因为这种差异，将订单簿模式与流动性池结合起来时也会面临一些问题， 因为订单簿的兑换价格和流动性池提供的兑换价格之间也会产生不一致。为了解决这个问题，在公式上加以调整，使兑换价格和兑换后的池价格相等：

$$ p_{p} = \frac{R_{x} + \Delta_{x}}{R_{y} - \frac{\Delta_{x}}{p_{s}}} = p_{s} $$

求解兑换价格 $p_{s}$ 的上述方程式结果如下：

$$ p_{s} = \frac{(R_{x} + 2 \Delta_{x})}{R_{y}} $$

相等兑换价格模式下兑换后的池价格跟最近的兑换价格一致，从而与恒定乘积模式相比减少套利机会。

![相等兑换价格模式下能进行有效的价格发现](./imgs/LiqMod/EfficientPriceDiscoveryFigure.png)

但值得注意的是，因价格相同而导致恒定乘积公式不再成立。这意味着流动性池内的余额是路径依赖的。 [@vitalik:PathIndependence]

对于给定兑换价格 $p_{s}$ ，该模式决定流动性池处理的订单数量，

$$
\begin{aligned}
\Delta_{y} &= \Delta_{x} = 0 & (p_{s} = p_{p}) \\
\Delta_{y} &= \frac{p_{s} R_{y} - R_{x}}{2p_{s}} & (p_{s} > p_{p}) \\
\Delta_{x} &= \frac{R_{x} - p_{s}R_{y}}{2} & (p_{s} < p_{p})
\end{aligned}
$$

![供求关系](./imgs/LiqMod/DemandSupply.png)

## 手续费

流动性模块涉及两种类型的手续费，就是资金池管理相关费用以及交易相关费用。所有手续费都有特定的经济目的。

**资金池管理**

- **创建资金池**: 创建新的资金池时需要支付手续费。此目的在于防止创建过多的资金池，并鼓励积极贡献给现有的流动性池。此项手续费以 ATOM 支付并纳入社区基金。
- **资金池提现**: 从资金池提取资金的投资者要支付与提取金额成比例的手续费。此项手续费积累在资金池内，目的在于保护其他投资者免受频繁存取款方式的攻击向量所害。

**交易手续费**

首先要注意，对区块中的每笔交易都会收取 Gas 费用。这些费用

- 每区块完成时收取
- 对最终未执行的订单也要收取
- 费用归属于 ATOM 委托者、验证者以及社区基金。 [@Cosmos:GasFees]

最后，与兑换数量成比例的兑换手续费要支付给进行执行的相应流动性池。此项手续费积累在资金池内，并按比例分配给每个资金池投资者。这类似于 Uniswap 模式。

初步分析提出以下手续费结构：

- 兑换费率 = 0.003 (0.3%)
- 提现费率 = 0.003 (0.3%)
- 新资金池创建费 = 100 ATOM

# 结论

本文概述了 Cosmos Hub AMM 的设计提案。我们相信，这将通过以下功能为 Cosmos 网络带来巨大的经济效用:

- 在不依赖中心化机构的情况下为代币兑换提供流动性；
- 通过 AMM 机制与传统订单簿系统的结合获得优良的流动性，
- Cosmos Network 用户通过参与流动性池享受赚取手续费的机会，
- 可以用任何代币化资产进行交易，包括不同 DeFi 投资代币

Cosmos Hub AMM 拥有振奋人心的潜力。再加上与 IBC 的资产转移能力相结合，会给 Cosmos Hub 提供机会成为跨链金融生态系统的重心。

打开以下链接，查看模块实现有关更多细节 https://github.com/tendermint/liquidity/tree/develop

# 参考文献
